#!/usr/bin/env bash
set -euo pipefail

# Web App Removal Tool for Arch Linux
# Removes desktop entries created by webapp-install
# Converted from Black Don OS NixOS implementation
VERSION="1.0.0"

# --- Helper Functions ---
print_help() {
  echo "Web App Removal Tool -- version $VERSION"
  echo ""
  echo "Usage: webapp-remove [APP_NAME]"
  echo ""
  echo "Interactive Mode (no arguments):"
  echo "  webapp-remove"
  echo "  - Lists all installed webapps and lets you select one to remove"
  echo ""
  echo "Direct Mode:"
  echo "  webapp-remove \"App Name\""
  echo "  - Removes the specified webapp"
  echo ""
  echo "Options:"
  echo "  --help, -h   - Show this help message"
  echo "  --list, -l   - List all installed webapps"
  echo ""
}

list_webapps() {
  echo "Installed webapps:"
  local found=false
  if [ -d "$HOME/.local/share/applications" ]; then
    for desktop in "$HOME/.local/share/applications"/*.desktop; do
      if [ -f "$desktop" ]; then
        if grep -q "Categories=.*WebApp" "$desktop" 2>/dev/null; then
          name=$(basename "$desktop" .desktop)
          url=$(grep "^Exec=" "$desktop" | sed 's/.*--app="\([^"]*\)".*/\1/' 2>/dev/null || echo "N/A")
          echo "  - $name ($url)"
          found=true
        fi
      fi
    done
  fi
  if [ "$found" = false ]; then
    echo "  No webapps found"
  fi
}

remove_webapp() {
  local app_name="$1"
  local desktop_file="$HOME/.local/share/applications/$app_name.desktop"
  local icon_name
  icon_name=$(echo "$app_name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
  local icon_file="$HOME/.local/share/icons/hicolor/256x256/apps/$icon_name.png"

  if [ ! -f "$desktop_file" ]; then
    echo "Error: Webapp '$app_name' not found" >&2
    echo "Available webapps:" >&2
    list_webapps >&2
    return 1
  fi

  echo "Removing webapp: $app_name"

  if [ -f "$desktop_file" ]; then
    rm "$desktop_file"
    echo "Removed desktop entry: $desktop_file"
  fi

  if [ -f "$icon_file" ]; then
    rm "$icon_file"
    echo "Removed icon: $icon_file"
  fi

  gtk-update-icon-cache -f -t "$HOME/.local/share/icons/hicolor" 2>/dev/null || true

  echo "Webapp '$app_name' removed successfully!"
}

# --- Main Logic ---
if [ "$#" -eq 1 ]; then
  case "$1" in
    --help|-h)
      print_help
      exit 0
      ;;
    --list|-l)
      list_webapps
      exit 0
      ;;
    *)
      remove_webapp "$1"
      exit 0
      ;;
  esac
fi

if [ "$#" -eq 0 ]; then
  # Interactive mode
  if ! command -v gum &>/dev/null; then
    echo "Error: gum is required for interactive mode. Install with: sudo pacman -S gum" >&2
    echo "Alternatively, use: webapp-remove \"App Name\"" >&2
    exit 1
  fi

  echo "Available webapps to remove:"
  echo ""

  webapps=()
  if [ -d "$HOME/.local/share/applications" ]; then
    for desktop in "$HOME/.local/share/applications"/*.desktop; do
      if [ -f "$desktop" ]; then
        if grep -q "Categories=.*WebApp" "$desktop" 2>/dev/null; then
          name=$(basename "$desktop" .desktop)
          webapps+=("$name")
        fi
      fi
    done
  fi

  if [ ${#webapps[@]} -eq 0 ]; then
    echo "No webapps found to remove."
    exit 0
  fi

  selected=$(printf '%s\n' "${webapps[@]}" | gum choose --header "Select webapp to remove:")

  if [ -n "$selected" ]; then
    echo ""
    remove_webapp "$selected"
  else
    echo "No webapp selected. Cancelled."
  fi
else
  echo "Error: Invalid arguments" >&2
  print_help
  exit 1
fi
